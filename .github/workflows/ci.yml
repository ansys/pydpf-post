name: GitHub Actions

on:
  pull_request:
    branches-ignore:
      - "*no-ci"

  push:
    tags:
      - "*"
    branches:
      - master
      - "release*"
      - "ci/*"

env:
  PYANSYS_OFF_SCREEN: True
  DPF_PORT: 32772
  PACKAGE_NAME: ansys-dpf-post

jobs:
  windows-2019_Py3_8:
    name: Windows 2019 Python 3.8
    runs-on: windows-2019

    env:
      ANSYS_VERSION: 221

    steps:
      - uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2.1.4
        with:
          python-version: 3.8

      - id: install-dpf
        uses: pyansys/pydpf-actions/install-dpf-server@v1
        with:
          dpf-standalone-TOKEN: ${{secrets.DPF_PIPELINE}}
          ANSYS_VERSION : ${{env.ANSYS_VERSION}}

      - name: Set AWP_ROOT$env:ANSYS_VERSION
        run: |
          echo AWP_ROOT$env:ANSYS_VERSION
          echo "AWP_ROOT$env:ANSYS_VERSION=${{ steps.install-dpf.outputs.SERVER }}"  | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf-8 -Append

      - name: Install ansys-dpf-post
        shell: cmd
        run: |
          pip install -r requirements_build.txt
          python setup.py bdist_wheel
          FOR /F %%a in ('dir /s/b dist\*.whl') do SET WHEELPATH=%%a
          ECHO %WHEELPATH%
          cd tests
          pip install %WHEELPATH%
          python -c "from ansys.dpf import post; print(post.Report(gpu=False))"

      - name: WHEEL publish artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ansys_dpf_post_wheel
          path: ./dist/*
