"""Module containing the ``DataObject`` class."""
from ansys.dpf.post.data import Data
from ansys.dpf.post.errors import PandasImportError


class DataObject:
    """Exposes the fields container generated by a result provider."""

    def __init__(
        self, fields_container=None, server=None, mesh_scoping=None, columns=None
    ):
        """Wrap a FieldsContainer within a DataObject.

        Parameters
        ----------
        fields_container:
            :class:`ansys.dpf.core.fields_container.FieldsContainer`to wrap.
        server:
            DPF server to use.
        mesh_scoping:
            Scoping to use.
        columns:
            Columns to use.
        """
        self._fc = fields_container
        if columns:
            self._columns = columns

        if mesh_scoping:
            self._mesh_scoping = mesh_scoping

        # super().__init__(fields_container._internal_obj, server)

    def __len__(self):
        """Return the length of the DataObject."""
        return len(self._fc)

    def __min__(self, **kwargs):
        """Return the minimum of the data."""
        return self.as_array().min()

    def __max__(self, **kwargs):
        """Return the maximum of the data."""
        return self.as_array().max()

    def __getitem__(self, value):
        """Return a Data in DataObject by index."""
        return Data(self._fc[value])

    def __str__(self):
        """Print DataObject information."""
        txt = f"DPF DataObject:\n {self._fc}"
        return txt

    def max(self, **kwargs):
        """Return the maximum of the data."""
        return float(self.as_array().max())

    def min(self, **kwargs):
        """Return the minimum of the data."""
        return float(self.as_array().min())

    def as_data_frame(self, columns=None, **kwargs):
        """Returns the data from the field container as a Pandas data_frame.

        Parameters
        ----------
        columns :
            Columns description.

        Returns
        -------
        class:`pandas.core.frame.DataFrame`

        Examples
        --------
        >>> import pandas as pd
        >>> from ansys.dpf.post import examples, load_simulation
        >>> simulation = load_simulation(examples.download_transient_result())
        >>> dispObject = simulation.displacement(nodes=[20, 200, 400], steps=[25])
        >>> df = dispObject.as_data_frame()
        >>> print(df)
             displacement_0.477975s X  ...  displacement_0.477975s Z
        20                  -0.005752  ...             -4.518793e-07
        200                 -0.001655  ...              4.959668e-08
        400                 -0.001658  ...              8.819955e-08
        <BLANKLINE>
        [3 rows x 3 columns]
        >>> print(df.columns)
        Index(['displacement_0.477975s X', 'displacement_0.477975s Y',
               'displacement_0.477975s Z'],
              dtype='object')
        >>> print(df.index)
        Int64Index([20, 200, 400], dtype='int64')

        """
        try:
            import pandas as pd
        except ModuleNotFoundError:
            raise PandasImportError

        if not columns:
            columns = self._columns

        # Initialize dataframe
        df = pd.DataFrame()
        for field in self:
            for component in range(field.n_dim):
                column_name = f"{field.name} {columns[component]}"
                ids = field.ids
                if field.n_dim > 1:
                    data = field.data[:, component]
                else:
                    data = field.data
                df = pd.concat(
                    [df, pd.DataFrame({column_name: data}, index=ids)], axis=1
                )

        # df = pd.DataFrame(
        #     self.as_array(), columns=columns, index=self._mesh_scoping.ids
        # )
        df.name = self._fc[-1].name
        return df

    def as_array(self):
        """Return the DataObject as a NumPy array.

        Returns
        -------
        class:`pandas.core.frame.DataFrame`

        Examples
        --------
        >>> import pandas as pd
        >>> from ansys.dpf import post
        >>> from ansys.dpf.post import examples
        >>> simulation = post.load_simulation(examples.multishells_rst)
        >>> # Export the displacements vector field at step 1 as a DataFrame
        >>> displacement = simulation.displacement(steps=[1], nodes=[1, 2, 3])
        >>> arr = displacement.as_array()
        >>> print(arr)
        [[  0.39831985 -13.79737819  -0.16376683]
         [  0.23311378 -13.79765179  -0.15318972]
         [  0.36754181 -13.80815135  -0.16373945]]

        """
        return self._fc[-1].data

    def plot(self, **kwargs):
        """Plot the result."""
        self._fc[-1].plot(**kwargs)

    def animate(self, **kwargs):
        """Animate the result.

        Returns
        -------
            The interactive plotter object used for animation.
        """
        return self._fc.animate(**kwargs)
